using System;
using System.Reflection;
using System.Text;
using TenCrowns.AppCore;
using TenCrowns.GameCore;
using UnityEngine;

namespace OldWorldAPIEndpoint
{
    /// <summary>
    /// Entry point for the Old World API Endpoint mod.
    /// Uses built-in ModEntryPointAdapter hooks instead of Harmony.
    /// </summary>
    public class APIEndpoint : ModEntryPointAdapter
    {
        private static TcpBroadcastServer _server;

        // Cached reflection info for accessing Game via AppMain
        private static Type _appMainType;
        private static FieldInfo _gAppField;
        private static PropertyInfo _clientProperty;
        private static PropertyInfo _gameProperty;
        private static bool _reflectionInitialized;

        /// <summary>
        /// Static accessor for the TCP server.
        /// </summary>
        public static TcpBroadcastServer Server => _server;

        /// <summary>
        /// Initialize reflection for accessing Game instance.
        /// We can't directly reference Assembly-CSharp, so we use reflection.
        /// </summary>
        private static void InitializeReflection()
        {
            if (_reflectionInitialized) return;

            try
            {
                // Find AppMain type in Assembly-CSharp
                foreach (var assembly in AppDomain.CurrentDomain.GetAssemblies())
                {
                    if (assembly.GetName().Name == "Assembly-CSharp")
                    {
                        _appMainType = assembly.GetType("AppMain");
                        break;
                    }
                }

                if (_appMainType != null)
                {
                    // Get static field gApp
                    _gAppField = _appMainType.GetField("gApp", BindingFlags.Public | BindingFlags.Static);

                    // Get Client property
                    _clientProperty = _appMainType.GetProperty("Client", BindingFlags.Public | BindingFlags.Instance);

                    if (_clientProperty != null)
                    {
                        // Get Game property from GameClientBehaviour
                        var clientType = _clientProperty.PropertyType;
                        _gameProperty = clientType.GetProperty("Game", BindingFlags.Public | BindingFlags.Instance);
                    }

                    Debug.Log($"[APIEndpoint] Reflection initialized: AppMain={_appMainType != null}, gApp={_gAppField != null}, Client={_clientProperty != null}, Game={_gameProperty != null}");
                }
                else
                {
                    Debug.LogWarning("[APIEndpoint] Could not find AppMain type");
                }
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] Reflection init error: {ex.Message}");
            }

            _reflectionInitialized = true;
        }

        /// <summary>
        /// Gets the current Game instance via reflection through AppMain.
        /// </summary>
        private static Game GetGame()
        {
            try
            {
                InitializeReflection();

                if (_gAppField == null || _clientProperty == null || _gameProperty == null)
                    return null;

                // AppMain.gApp
                var appMain = _gAppField.GetValue(null);
                if (appMain == null) return null;

                // appMain.Client
                var client = _clientProperty.GetValue(appMain);
                if (client == null) return null;

                // client.Game
                return _gameProperty.GetValue(client) as Game;
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] GetGame error: {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Builds JSON array of all players with their data and stockpiles.
        /// </summary>
        private static string BuildPlayersJson(Game game)
        {
            var sb = new StringBuilder();
            sb.Append("[");

            try
            {
                Player[] players = game.getPlayers();
                Infos infos = game.infos();
                int yieldCount = (int)infos.yieldsNum();
                bool firstPlayer = true;

                for (int i = 0; i < players.Length; i++)
                {
                    Player player = players[i];
                    if (player == null) continue;

                    if (!firstPlayer) sb.Append(",");
                    firstPlayer = false;

                    // Get nation name via Infos
                    NationType nationId = player.getNation();
                    string nationName = infos.nation(nationId).mzType;

                    sb.Append("{");
                    sb.Append($"\"index\":{i},");
                    sb.Append($"\"nation\":\"{nationName}\",");
                    sb.Append($"\"cities\":{player.getNumCities()},");
                    sb.Append($"\"units\":{player.getNumUnits()},");
                    sb.Append($"\"legitimacy\":{player.getLegitimacy()},");

                    // Stockpiles
                    sb.Append("\"stockpiles\":{");
                    for (int y = 0; y < yieldCount; y++)
                    {
                        if (y > 0) sb.Append(",");
                        YieldType yieldType = (YieldType)y;
                        InfoYield yieldInfo = infos.yield(yieldType);
                        int amount = player.getYieldStockpileWhole(yieldType);
                        sb.Append($"\"{yieldInfo.mzType}\":{amount}");
                    }
                    sb.Append("}");

                    sb.Append("}");
                }
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] BuildPlayersJson error: {ex.Message}");
            }

            sb.Append("]");
            return sb.ToString();
        }

        public override void Initialize(ModSettings modSettings)
        {
            base.Initialize(modSettings);

            try
            {
                // Reuse existing server if already running (mod can be re-initialized)
                if (_server == null)
                {
                    _server = new TcpBroadcastServer(9876);
                    _server.Start();
                    Debug.Log("[APIEndpoint] Initialized - TCP server started on port 9876");
                }
                else
                {
                    Debug.Log("[APIEndpoint] Initialized - reusing existing TCP server");
                }
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] Initialization failed: {ex}");
            }
        }

        public override void Shutdown()
        {
            // Keep server running across game sessions - only log shutdown
            // The server will be reused when Initialize is called again
            Debug.Log("[APIEndpoint] Shutdown called (server kept running for reconnection)");
            base.Shutdown();
        }

        /// <summary>
        /// Called by the game at the start of each new turn (server-side).
        /// </summary>
        public override void OnNewTurnServer()
        {
            try
            {
                var game = GetGame();

                string json;
                if (game != null)
                {
                    int turn = game.getTurn();
                    int year = game.getYear();
                    int currentPlayer = (int)game.getPlayerTurn();
                    string playersJson = BuildPlayersJson(game);

                    json = $"{{\"event\":\"newTurn\",\"turn\":{turn},\"year\":{year}," +
                           $"\"currentPlayer\":{currentPlayer},\"players\":{playersJson}}}";
                    Debug.Log($"[APIEndpoint] OnNewTurnServer - turn {turn}, year {year}, player {currentPlayer}");
                }
                else
                {
                    json = "{\"event\":\"newTurn\",\"error\":\"game not available\"}";
                    Debug.LogWarning("[APIEndpoint] OnNewTurnServer - game instance not available");
                }

                // Broadcast to all connected clients
                _server?.Broadcast(json);
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] OnNewTurnServer error: {ex.Message}");
            }
        }

        /// <summary>
        /// Called when the game server is ready.
        /// </summary>
        public override void OnGameServerReady()
        {
            try
            {
                var game = GetGame();

                string json;
                if (game != null)
                {
                    int turn = game.getTurn();
                    int year = game.getYear();
                    int currentPlayer = (int)game.getPlayerTurn();
                    string playersJson = BuildPlayersJson(game);

                    json = $"{{\"event\":\"gameReady\",\"turn\":{turn},\"year\":{year}," +
                           $"\"currentPlayer\":{currentPlayer},\"players\":{playersJson}}}";
                    Debug.Log($"[APIEndpoint] OnGameServerReady - turn {turn}, year {year}, player {currentPlayer}");
                }
                else
                {
                    json = "{\"event\":\"gameReady\"}";
                    Debug.Log("[APIEndpoint] OnGameServerReady - game started (no game instance yet)");
                }

                _server?.Broadcast(json);
            }
            catch (Exception ex)
            {
                Debug.LogError($"[APIEndpoint] OnGameServerReady error: {ex.Message}");
            }
        }
    }
}
